#!/usr/bin/env node
const yeoman=require("yeoman-environment"),env=yeoman.createEnv(),commander=require("commander"),program=new commander.Command,path=require("path"),chalk=require("chalk"),fs=require("fs"),yaml=require("js-yaml"),config=require("../config"),defaults=config.defaults,basePath=config.basePath,run=options=>{const schemaFolder=options.schemaFolder||defaults.schemaFolder,schema=options.schema||"",outputLogicFolder=options.outputLogicFolder||defaults.outputLogicFolder,outputThemeFolder=options.outputThemeFolder||defaults.outputThemeFolder,outputTheme=options.outputTheme||defaults.outputTheme,opt={schemaFolder:schemaFolder,outputLogicFolder:outputLogicFolder,outputThemeFolder:outputThemeFolder,outputTheme:outputTheme};if(schema)console.log({opt:opt}),runYeoman(schema,opt);else{const schemaFolder=path.join(opt.schemaFolder,"schema");console.log({schemaFolder:schemaFolder}),files=fs.readdir(schemaFolder,(function(e,files){console.log(files);for(var i=0;i<files.length;i++)console.log(files[i]),fileParts=files[i].split("."),"yml"==fileParts[1]&&runYeoman(fileParts[0],opt)}))}},runYeoman=(modelName,options)=>{const generatorName="crud",generatorPath=path.join(__dirname,"..","generators","crud");env.register(generatorPath,"crud");const cmd=`crud ${modelName} ${options.schemaFolder} ${options.outputLogicFolder} ${options.outputThemeFolder} ${options.outputTheme}`;env.run(cmd).then(e=>{e&&console.log(e)})};program.option("--schema-folder <folder>","Looks in the app folder for a schema folder by default. You can change this to point to a module folder (e.g. `module/my-module`).").option("--schema <schema>","schema file to read. If not set, all files in the folder will be processed").option("--output-logic-folder <folder>","Defaults to modules/func. You can change this to point to a another folder (e.g. `app` or `module/my-module/public`)").option("--output-theme-folder <folder>","Defaults to modules/theme. You can change this to point to a another folder (e.g. `app` or `module/my-module`)").option("--output-theme-name <theme>","Defaults to simple. You can change this to another theme").action((function(options){run(options)})),program.parse(process.argv);